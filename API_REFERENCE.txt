================================================================================
CAMPUSVOICE - COMPLETE FRONTEND DEVELOPER REFERENCE
================================================================================
Production URL: https://campusvoice-api-h528.onrender.com
Local Dev URL:  http://localhost:8000
API Prefix:     /api
Swagger Docs:   /docs (dev only)

This document is split into 12 self-contained sections.
Each section can be used as a standalone prompt for Antigravity or any AI tool.
Copy-paste any section individually -- it has all the context it needs.

================================================================================
SECTION 1: HOW THE BACKEND WORKS (THEORY)
================================================================================

CampusVoice is a campus complaint management system for SREC college.
Students submit complaints -> AI categorizes & routes them -> Authorities handle them.

THE THREE USER ROLES:
  1. Student   - registers, submits complaints, votes, views public feed
  2. Authority - warden/HOD/officer who receives & resolves assigned complaints
  3. Admin     - the top-level authority (level 100) who manages the entire system

IMPORTANT: Authority and Admin are NOT separate database tables. Admin is just
an Authority with authority_level=100 and authority_type="Admin". The JWT token
has role="Admin" for level-100 authorities and role="Authority" for all others.

LOGIN ENDPOINTS ARE SEPARATE:
  Students   -> POST /api/students/login
  Authorities (including Admin) -> POST /api/authorities/login

HOW A COMPLAINT FLOWS:
  1. Student fills form: Writes complaint text + chooses visibility (Private/Public).
     NO CATEGORY SELECTION - AI determines category automatically from text.
     Optional image can be attached.
  2. Backend sends text to Groq LLM which:
     - Checks for spam/abuse (rejects if spam)
     - AUTOMATICALLY CATEGORIZES complaint (Men's/Women's Hostel, General, Dept, Disciplinary)
     - DETECTS TARGET DEPARTMENT from keywords (e.g., "ECE lab" → ECE department)
     - ENABLES CROSS-DEPARTMENT ROUTING (CSE student → ECE lab → routes to ECE HOD)
     - Decides if image evidence is needed (rejects if needed but missing)
     - Rephrases text into professional language
     - Suggests priority (Low/Medium/High/Critical)
  3. Backend uses LLM's category + target dept to route to correct authority:
     - Men's Hostel    -> Men's Hostel Warden
     - Women's Hostel  -> Women's Hostel Warden
     - General         -> Admin Officer
     - Department      -> HOD of target department (auto-detected, not student's dept)
     - Disciplinary    -> Disciplinary Committee
  4. Backend validates: Day Scholars can't submit hostel, gender restrictions apply
  5. Authority sees complaint on their dashboard
  6. Authority changes status: Raised -> In Progress -> Resolved -> Closed
  7. Student gets notifications at each status change
  8. If authority can't handle it, they escalate to next level

  IMPORTANT: This is a FULLY AI-DRIVEN system. Students do NOT select category_id.
  The system analyzes complaint text to determine category, target department, and
  whether cross-department routing is needed. Backend still enforces business rules.

THE AUTHORITY HIERARCHY (higher number = more power):
  Men's Hostel Warden       (level 5)
  Women's Hostel Warden     (level 5)
  HOD                       (level 8)
  Men's Hostel Deputy Warden  (level 10)
  Women's Hostel Deputy Warden (level 10)
  Senior Deputy Warden      (level 15)
  Disciplinary Committee    (level 20)
  Admin Officer             (level 50)
  Admin                     (level 100)

ESCALATION CHAINS:
  Men's Hostel:  Warden -> Deputy Warden -> Senior Deputy Warden -> Admin
  Women's Hostel: Warden -> Deputy Warden -> Senior Deputy Warden -> Admin
  Department:    HOD -> Admin
  General:       Admin Officer -> Admin
  Disciplinary:  Disciplinary Committee -> Admin


================================================================================
SECTION 2: AUTHENTICATION & TOKENS
================================================================================

AUTH METHOD: JWT Bearer tokens
ALGORITHM:  HS256
EXPIRY:     7 days (604800 seconds)

TOKEN PAYLOAD STRUCTURE:
{
  "sub": "22CS231" or "5",       // roll_no for students, authority ID for authorities
  "role": "Student" | "Authority" | "Admin",
  "exp": 1738000000              // unix timestamp
}

HOW TO USE:
  Every request (except login/register) must include:
  Header: Authorization: Bearer eyJhbGciOiJIUzI1NiIs...

PUBLIC ENDPOINTS (no token needed):
  POST /api/students/register
  POST /api/students/login
  POST /api/authorities/login
  GET  /health
  GET  /health/detailed

ALL OTHER ENDPOINTS NEED A VALID TOKEN.

THREE SEPARATE LOGIN FLOWS:

  STUDENT LOGIN:
    POST /api/students/login
    Body: { "email_or_roll_no": "22CS231", "password": "Pass@123" }
    Response includes: roll_no, name, email, gender, stay_type, department_id,
                       department_name, token, token_type, expires_in

  AUTHORITY LOGIN (Wardens, HODs, Officers, Disciplinary Committee):
    POST /api/authorities/login
    Body: { "email": "warden1.mens@srec.ac.in", "password": "MensW1@1234" }
    Response includes: id, name, email, authority_type, department_id,
                       designation, token, token_type, expires_in

  ADMIN LOGIN (same endpoint as authority):
    POST /api/authorities/login
    Body: { "email": "admin@srec.ac.in", "password": "Admin@123456" }
    Response: same as authority, but authority_type="Admin", authority_level=100
    The token will have role="Admin"

HOW TO DETERMINE USER TYPE FROM TOKEN:
  Decode JWT -> check "role" field:
    "Student"   -> show student UI
    "Authority" -> show authority dashboard
    "Admin"     -> show admin panel (superset of authority features)

CORS SETTINGS:
  Allowed Origins: configurable via CORS_ORIGINS env var
  Methods: GET, POST, PUT, DELETE, PATCH, OPTIONS
  Headers: all
  Credentials: true

TOKEN EXPIRY HANDLING:
  When token expires, API returns:
  { "success": false, "error_code": "AUTH_003", "error": "Token expired" }
  Frontend should redirect to login page.


================================================================================
SECTION 3: ALL VALID ENUMS & IDs
================================================================================

USE THESE EXACT VALUES. Case-sensitive. No alternatives accepted.

--- DEPARTMENTS (send as integer department_id, NOT string code) ---
  1  = CSE        Computer Science & Engineering
  2  = ECE        Electronics & Communication Engineering
  3  = RAA        Robotics and Automation
  4  = MECH       Mechanical Engineering
  5  = EEE        Electrical & Electronics Engineering
  6  = EIE        Electronics & Instrumentation Engineering
  7  = BIO        Biomedical Engineering
  8  = AERO       Aeronautical Engineering
  9  = CIVIL      Civil Engineering
  10 = IT         Information Technology
  11 = MBA        Management Studies
  12 = AIDS       Artificial Intelligence and Data Science
  13 = MTECH_CSE  M.Tech in Computer Science and Engineering

--- COMPLAINT CATEGORIES (send as integer category_id) ---
  1 = Men's Hostel            (room, mess, food, water, bathroom, fan, bed)
  2 = Women's Hostel          (room, mess, food, water, bathroom, fan, bed)
  3 = General                 (canteen, library, playground, wifi, parking, gym)
  4 = Department              (lab, class, exam, faculty, professor)
  5 = Disciplinary Committee  (ragging, harassment, bullying, safety, violence)

  WARNING: There are 5 categories, NOT 4. "Hostel" was split into
  "Men's Hostel" (id=1) and "Women's Hostel" (id=2).

--- COMPLAINT STATUS (exact strings, case-sensitive) ---
  "Raised"        initial status when complaint is submitted
  "In Progress"   authority is working on it
  "Resolved"      authority marked it as fixed
  "Closed"        final/terminal status, no more changes
  "Spam"          flagged as spam by authority

  Status flow: Raised -> In Progress -> Resolved -> Closed
  Also valid: Raised -> Spam -> Closed
  Also valid: In Progress -> Raised (send back)
  Also valid: Resolved -> Raised (reopen)
  NOT valid: Closed -> anything (terminal)

--- PRIORITY LEVELS ---
  "Low"       score 0-49
  "Medium"    score 50-99
  "High"      score 100-199
  "Critical"  score 200+

--- VISIBILITY LEVELS (✅ UPDATED: 2 OPTIONS ONLY) ---
  "Private"      only student + assigned authority can see
  "Public"       all students can see (with automatic filtering - see Section 9)

  NOTE: "Department" visibility was REMOVED in the fully AI-driven system.
  Students now only choose between "Private" and "Public".

--- GENDER ---
  "Male" | "Female" | "Other"

--- STAY TYPE ---
  "Hostel" | "Day Scholar"

--- STUDENT YEAR ---
  integer: 1, 2, 3, 4 (up to 10 for postgrad)

--- VOTE TYPE ---
  "Upvote" | "Downvote"
  WARNING: Capital U and D. Not "upvote"/"downvote".

--- AUTHORITY TYPES ---
  "Admin"
  "Admin Officer"
  "Men's Hostel Warden"
  "Women's Hostel Warden"
  "Men's Hostel Deputy Warden"
  "Women's Hostel Deputy Warden"
  "Senior Deputy Warden"
  "HOD"
  "Disciplinary Committee"


================================================================================
SECTION 4: STUDENT ENDPOINTS
================================================================================

--- 4.1 Register Student ---
POST /api/students/register
Auth: None
Content-Type: application/json
Success: 201

Request:
{
  "roll_no": "22CS231",           // 5-20 chars, alphanumeric, REQUIRED, UNIQUE
  "name": "Arjun Kumar",          // 2-255 chars, no digits allowed, REQUIRED
  "email": "arjun@srec.ac.in",    // valid email, REQUIRED, UNIQUE
  "password": "Secure@Pass1",     // min 8 chars, 1 upper + 1 lower + 1 digit + 1 special, REQUIRED
  "gender": "Male",               // "Male"|"Female"|"Other", REQUIRED
  "stay_type": "Hostel",          // "Hostel"|"Day Scholar", REQUIRED
  "department_id": 1,             // integer 1-13, REQUIRED
  "year": 2                       // integer 1-10, OPTIONAL
}

Response (201):
{
  "roll_no": "22CS231",
  "name": "Arjun Kumar",
  "email": "arjun@srec.ac.in",
  "gender": "Male",
  "stay_type": "Hostel",
  "year": 2,
  "department_id": 1,
  "department_name": "Computer Science & Engineering",
  "token": "eyJhbGciOiJIUzI...",
  "token_type": "Bearer",
  "expires_in": 604800
}

Errors:
  400 - { "error": "Email already registered" } or roll_no already registered
  422 - { "error": "Validation error", "details": { "validation_errors": [...] } }

PASSWORD RULES:
  - Minimum 8 characters
  - At least 1 uppercase letter (A-Z)
  - At least 1 lowercase letter (a-z)
  - At least 1 digit (0-9)
  - At least 1 special character (@$!%*?&)


--- 4.2 Login Student ---
POST /api/students/login
Auth: None
Content-Type: application/json
Success: 200

Request:
{
  "email_or_roll_no": "arjun@srec.ac.in",  // email OR roll_no, min 3 chars, REQUIRED
  "password": "Secure@Pass1"               // min 8 chars, REQUIRED
}

Response (200): same structure as register response

Errors:
  401 - Invalid credentials
  403 - Account inactive (admin deactivated this student)


--- 4.3 Get Student Profile ---
GET /api/students/profile
Auth: Student token
Success: 200

Response:
{
  "roll_no": "22CS231",
  "name": "Arjun Kumar",
  "email": "arjun@srec.ac.in",
  "gender": "Male",
  "stay_type": "Hostel",
  "department_id": 1,
  "department_name": "Computer Science & Engineering",
  "department_code": "CSE",
  "year": 2,
  "is_active": true,
  "email_verified": true,
  "created_at": "2026-02-01T10:30:00"
}


--- 4.4 Update Student Profile ---
PUT /api/students/profile
Auth: Student token
Content-Type: application/json
Success: 200

Request (all fields optional, send only what changed):
{
  "name": "Arjun Kumar S",
  "email": "arjun2@srec.ac.in",
  "phone": "9876543210",           // 10 digits, must start with 6-9
  "year": 3
}

Response: same as Get Profile


--- 4.5 Change Password ---
POST /api/students/change-password
Auth: Student token
Content-Type: application/json
Success: 200

Request:
{
  "old_password": "Secure@Pass1",
  "new_password": "NewSecure@Pass2",     // must differ from old, same rules
  "confirm_password": "NewSecure@Pass2"  // must match new_password
}

Response: { "success": true, "message": "Password changed successfully" }


--- 4.6 Get Student Stats ---
GET /api/students/stats
Auth: Student token
Success: 200

Response:
{
  "total_complaints": 10,
  "raised": 2,
  "in_progress": 3,
  "resolved": 4,
  "closed": 1,
  "spam": 0,
  "total_votes_cast": 25
}


--- 4.7 Get My Complaints ---
GET /api/students/my-complaints?skip=0&limit=20&status_filter=Raised
Auth: Student token
Success: 200

Query Params:
  skip          integer >= 0, default 0
  limit         integer 1-100, default 20
  status_filter optional: "Raised"|"In Progress"|"Resolved"|"Closed"|"Spam"

Response: see ComplaintListResponse in Section 7


--- 4.8 Get Notifications ---
GET /api/students/notifications?skip=0&limit=20&unread_only=false
Auth: Student token
Success: 200

Response:
{
  "notifications": [
    {
      "id": 1,
      "recipient_type": "Student",
      "complaint_id": "uuid-string" | null,
      "notification_type": "status_update",
      "message": "Your complaint status changed to In Progress",
      "is_read": false,
      "created_at": "2026-02-01T10:00:00Z",
      "read_at": null,
      "complaint_title": null,
      "complaint_status": null
    }
  ],
  "total": 10,
  "unread_count": 3
}

Notification types: "status_update", "complaint_assigned", "escalation",
  "spam_alert", "comment_added", "vote_milestone", "complaint_resolved",
  "complaint_closed", "authority_update_posted", "urgent_update"


--- 4.9 Get Unread Notification Count ---
GET /api/students/notifications/unread-count
Auth: Student token
Success: 200
Response: { "unread_count": 3 }


--- 4.10 Mark Notification as Read ---
PUT /api/students/notifications/{notification_id}/read
Auth: Student token
Success: 200
Response: { "success": true, "message": "Notification marked as read" }


--- 4.11 Mark All Notifications as Read ---
PUT /api/students/notifications/mark-all-read
Auth: Student token
Success: 200
Response: { "success": true, "message": "Marked 5 notifications as read" }


--- 4.12 Delete Notification ---
DELETE /api/students/notifications/{notification_id}
Auth: Student token
Success: 200
Response: { "success": true, "message": "Notification deleted successfully" }


================================================================================
SECTION 5: COMPLAINT ENDPOINTS
================================================================================

--- 5.1 Submit Complaint (✅ FULLY AI-DRIVEN) ---
POST /api/complaints/submit
Auth: Student token
Content-Type: multipart/form-data (NOT application/json)
Success: 201

Form Fields:
  original_text  string, 10-2000 chars, not ALL CAPS, REQUIRED
  visibility     string, optional, default "Public": "Private"|"Public"
  image          file, optional, JPEG/PNG/GIF/WebP, max 5MB

✅ FULLY AI-DRIVEN SYSTEM (NO CATEGORY SELECTION REQUIRED):
  - Students do NOT select category - AI determines it automatically
  - category_id field is REMOVED from form (deprecated if sent)
  - LLM analyzes complaint text to determine:
    * Category (Men's Hostel, Women's Hostel, General, Department, Disciplinary)
    * Target department (based on complaint content, not student's department)
    * Priority level (Low, Medium, High, Critical)
    * Whether cross-department routing is needed
  - Visibility options: ONLY "Private" or "Public" (no "Department")

FRONTEND NOTE: Use FormData (simpler now without category):
  const formData = new FormData();
  formData.append('original_text', 'The ECE lab equipment is broken...');
  formData.append('visibility', 'Public');  // Only Private or Public
  formData.append('image', fileInput.files[0]);  // optional

  fetch('/api/complaints/submit', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + token },
    // DO NOT set Content-Type -- browser sets it with boundary
    body: formData
  });

✅ AUTOMATIC CATEGORY/DEPARTMENT DETECTION:
  - AI detects category from complaint text (no student input needed)
  - AI detects target department from keywords:
    * "ECE lab" → routes to ECE department HOD
    * "mechanical workshop" → routes to MECH department
    * "Our classroom" → routes to student's own department
  - Cross-department complaints automatically handled
  - Backend still validates based on student profile (Day Scholars rejected for hostel)

WHAT HAPPENS ON SUBMIT:
  1. Spam check -> if spam, returns 400 with error
  2. LLM categorizes complaint AUTOMATICALLY (no student selection)
  3. LLM detects target department from complaint text
  4. Image requirement check -> if image needed but missing, returns 400
  5. LLM rephrases text professionally
  6. LLM suggests priority
  7. Complaint auto-routed to correct authority + department
  8. If image attached, AI verifies relevance

Response (201):
{
  "id": "a1b2c3d4-...",
  "status": "Submitted",
  "message": "Your complaint has been submitted and assigned to Men's Hostel Warden",
  "rephrased_text": "The ceiling fan in Room 204...",
  "priority": "Medium",
  "assigned_authority": "Men's Hostel Warden",
  "category": "Men's Hostel",
  "target_department_id": 1,
  "target_department_code": "CSE",
  "cross_department": false,
  "llm_failed": false,
  "confidence_score": 0.95,
  "has_image": false,
  "image_verified": false,
  "image_verification_status": null,
  "image_verification_message": null,
  "image_was_required": false,
  "image_requirement_reasoning": null
}

Errors:
  400 - Spam detected | Image required but not provided | Day scholar hostel restriction
  422 - Validation error (text too short, invalid visibility, etc.)
  500 - LLM service temporarily unavailable


--- 5.2 Get Public Feed (✅ UPDATED FILTERING) ---
GET /api/complaints/public-feed?skip=0&limit=20
Auth: Student token
Success: 200

Response: ComplaintListResponse (see Section 7)

IMPORTANT FILTERING RULES (backend applies automatically):
  - Only "Public" visibility complaints are shown (✅ Department removed)
  - "Closed" status complaints are hidden
  - Day Scholar students CANNOT see Men's/Women's Hostel complaints
  - Male students CANNOT see Women's Hostel complaints
  - Female students CANNOT see Men's Hostel complaints
  - ✅ NEW: Inter-department filtering with exceptions:
    * Students can ONLY see complaints from their OWN department
    * EXCEPTION 1: "General" category complaints visible to ALL students
    * EXCEPTION 2: "Disciplinary Committee" complaints visible to ALL students
    * EXCEPTION 3: Cross-department complaints visible to TARGET department
    * Example: ECE student sees (ECE dept + General + Disciplinary)
    * Example: CSE student complains about "ECE lab" → ECE students CAN see it

PRIVACY: student_roll_no and student_name are ALWAYS null in public feed.


--- 5.3 Get Complaint Details ---
GET /api/complaints/{complaint_id}
Auth: Student token
Path: complaint_id = UUID string
Success: 200

Response: ComplaintDetailResponse (see Section 7)
Errors: 404 if not found or not visible to this student


--- 5.4 Vote on Complaint ---
POST /api/complaints/{complaint_id}/vote
Auth: Student token
Content-Type: application/json
Success: 200

Request:
{ "vote_type": "Upvote" }       // "Upvote" or "Downvote" (capital first letter!)

Response:
{
  "complaint_id": "uuid-string",
  "upvotes": 15,
  "downvotes": 2,
  "priority_score": 51.3,
  "priority": "Medium",
  "user_vote": "Upvote"
}

SCORING: Each Upvote adds +5, each Downvote adds -3 to priority_score.
Priority auto-adjusts: Low(<50), Medium(50-99), High(100-199), Critical(200+).
Each student can only vote ONCE per complaint.

Errors: 400 - "You have already voted on this complaint"


--- 5.5 Remove Vote ---
DELETE /api/complaints/{complaint_id}/vote
Auth: Student token
Success: 200
Response: { "success": true, "message": "Vote removed successfully" }


--- 5.6 Check My Vote ---
GET /api/complaints/{complaint_id}/my-vote
Auth: Student token
Success: 200

Response:
{
  "complaint_id": "uuid-string",
  "has_voted": true,
  "vote_type": "Upvote" | "Downvote" | null
}


--- 5.7 Upload Image to Existing Complaint ---
POST /api/complaints/{complaint_id}/upload-image
Auth: Student token (must own the complaint)
Content-Type: multipart/form-data
Success: 200

Form: file = <binary image file> (JPEG/PNG/GIF/WebP, max 5MB)

Response:
{
  "complaint_id": "uuid-string",
  "has_image": true,
  "image_verified": true,
  "verification_status": "Verified",
  "verification_message": "Image is relevant to the complaint",
  "image_filename": "broken_fan.jpg",
  "image_size": 245678,
  "image_mimetype": "image/jpeg",
  "confidence_score": 0.95
}


--- 5.8 Get Complaint Image ---
GET /api/complaints/{complaint_id}/image?thumbnail=false
Auth: Student token
Success: 200

Returns: BINARY IMAGE DATA (not JSON)
  Content-Type: image/jpeg or image/png
  Content-Disposition: inline; filename="image.jpg"

Use thumbnail=true for 200x200 optimized version.

FRONTEND NOTE: Use as image src:
  <img src="/api/complaints/{id}/image?thumbnail=true"
       headers will need auth token -- use fetch + blob URL instead:

  const res = await fetch(`/api/complaints/${id}/image?thumbnail=true`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  const blob = await res.blob();
  img.src = URL.createObjectURL(blob);

Errors: 404 if no image attached


--- 5.9 Verify Complaint Image ---
POST /api/complaints/{complaint_id}/verify-image
Auth: Student token (must own)
Success: 200
Triggers AI re-verification on existing image.
Response: same as upload-image response


--- 5.10 Get Status History ---
GET /api/complaints/{complaint_id}/status-history
Auth: Student token
Success: 200

Response:
{
  "complaint_id": "uuid-string",
  "current_status": "Resolved",
  "status_updates": [
    {
      "old_status": "Raised",
      "new_status": "In Progress",
      "reason": "Maintenance team notified",
      "updated_by": "Dr. Rajesh Kumar",
      "updated_at": "2026-02-01T12:00:00+00:00"
    }
  ]
}


--- 5.11 Get Complaint Timeline ---
GET /api/complaints/{complaint_id}/timeline
Auth: Student token
Success: 200

Response:
{
  "complaint_id": "uuid-string",
  "timeline": [
    {
      "event": "Complaint Submitted",
      "timestamp": "2026-02-01T10:00:00+00:00",
      "description": "Complaint raised by Arjun Kumar"
    },
    {
      "event": "Status Changed",
      "timestamp": "2026-02-01T12:00:00+00:00",
      "description": "Status changed from Raised to In Progress",
      "reason": "Maintenance team notified",
      "updated_by": "Dr. Rajesh Kumar"
    }
  ]
}


--- 5.12 Advanced Filter ---
GET /api/complaints/filter/advanced
Auth: Student token
Success: 200

Query Parameters (all optional):
  skip            integer >= 0, default 0
  limit           integer 1-100, default 20
  status          "Raised"|"In Progress"|"Resolved"|"Closed"|"Spam"
  priority        "Low"|"Medium"|"High"|"Critical"
  category_id     integer (1-5)
  has_image       boolean
  image_verified  boolean
  search          string, min 2 chars (searches complaint text)
  date_from       ISO datetime "2026-01-01T00:00:00"
  date_to         ISO datetime

Response: ComplaintListResponse (see Section 7)


================================================================================
SECTION 6: AUTHORITY ENDPOINTS
================================================================================

--- 6.1 Authority Login ---
POST /api/authorities/login
Auth: None
Content-Type: application/json
Success: 200

Request:
{
  "email": "warden1.mens@srec.ac.in",
  "password": "MensW1@1234"
}

Response:
{
  "id": 6,
  "name": "Men's Hostel Warden (Block A)",
  "email": "warden1.mens@srec.ac.in",
  "authority_type": "Men's Hostel Warden",
  "department_id": null,
  "designation": "Warden",
  "token": "eyJhbGciOiJIUzI...",
  "token_type": "Bearer",
  "expires_in": 604800
}


--- 6.2 Get Authority Profile ---
GET /api/authorities/profile
Auth: Authority token
Success: 200

Response:
{
  "id": 6,
  "name": "Men's Hostel Warden (Block A)",
  "email": "warden1.mens@srec.ac.in",
  "phone": null,
  "authority_type": "Men's Hostel Warden",
  "department_id": null,
  "department_name": null,
  "designation": "Warden",
  "authority_level": 5,
  "is_active": true,
  "created_at": "2026-02-01T09:00:00"
}

NOTE on authority_type: This tells you what kind of authority they are.
  Use it to customize the dashboard UI (e.g., show "Hostel Complaints"
  header for wardens, "Department Complaints" for HODs).


--- 6.3 Get Dashboard ---
GET /api/authorities/dashboard
Auth: Authority token
Success: 200

Response:
{
  "profile": { /* full AuthorityProfile object */ },
  "stats": {
    "total_assigned": 50,
    "pending": 5,
    "in_progress": 10,
    "resolved": 30,
    "closed": 5,
    "spam_flagged": 2,
    "avg_resolution_time_hours": null,
    "performance_rating": null
  },
  "recent_complaints": [ /* last 10 complaints as dicts */ ],
  "urgent_complaints": [ /* High/Critical priority, status Raised/In Progress */ ],
  "unread_notifications": 3
}

ABOUT avg_resolution_time_hours AND performance_rating:
  These fields exist in the response schema but are NOT YET IMPLEMENTED.
  They will always be null for now. Do not build UI features around them yet.
  When implemented, performance_rating will be 0.0-5.0 scale.


--- 6.4 Get Assigned Complaints ---
GET /api/authorities/my-complaints?skip=0&limit=20&status_filter=Raised
Auth: Authority token
Success: 200

Response: ComplaintListResponse (see Section 7)

PRIVACY RULES (backend enforces):
  - Non-spam complaints: student_roll_no and student_name are NULL (hidden)
  - Spam-flagged complaints: student info IS visible (for investigation)
  - Admin (level 100): can see ALL student info on ALL complaints


--- 6.5 Get Specific Complaint ---
GET /api/authorities/complaints/{complaint_id}
Auth: Authority token (must be assigned to this complaint)
Success: 200

Response: ComplaintDetailResponse (see Section 7)
Errors: 404 if not assigned to this authority


--- 6.6 Update Complaint Status ---
PUT /api/authorities/complaints/{complaint_id}/status
Auth: Authority token (must be assigned)
Content-Type: application/json
Success: 200

Request:
{
  "status": "In Progress",               // REQUIRED, see valid transitions
  "reason": "Maintenance team notified"   // OPTIONAL (REQUIRED for "Closed" or "Spam")
}

Valid transitions:
  "Raised"      -> "In Progress", "Spam", "Closed"
  "In Progress" -> "Resolved", "Raised", "Closed"
  "Resolved"    -> "Closed", "Raised"
  "Closed"      -> (nothing - terminal)
  "Spam"        -> "Closed"

Response: { "success": true, "message": "Complaint status updated to 'In Progress'" }

Side effects: Creates StatusUpdate record, notifies student.
If status="Resolved", sets resolved_at timestamp.

Errors:
  400 - Invalid status transition
  403 - Not assigned to this complaint
  404 - Complaint not found


--- 6.7 Post Update on Complaint ---
POST /api/authorities/complaints/{complaint_id}/post-update
Auth: Authority token (must be assigned)
Success: 200

Query Parameters (NOT body):
  title    string, REQUIRED
  content  string, REQUIRED

Example: POST /api/authorities/complaints/{id}/post-update?title=Update&content=Plumber%20dispatched

Response: { "success": true, "message": "Update posted successfully" }
Notifies the student.


--- 6.8 Escalate Complaint ---
POST /api/authorities/complaints/{complaint_id}/escalate
Auth: Authority token (must be assigned)
Success: 200

Query Parameters:
  reason   string, REQUIRED

Response: { "success": true, "message": "Complaint escalated to Deputy Warden" }

What happens:
  - Complaint reassigned to next-level authority in escalation chain
  - Notifications sent to student AND new authority
  - Original authority can no longer see this complaint in their list

Errors: 400 if already at top of escalation chain (Admin)


--- 6.9 Get Escalation History ---
GET /api/authorities/complaints/{complaint_id}/escalation-history
Auth: Authority token
Success: 200

Response:
{
  "complaint_id": "uuid-string",
  "escalation_count": 2,
  "history": [
    {
      "level": 5,
      "authority_name": "Men's Hostel Warden (Block A)",
      "authority_type": "Men's Hostel Warden",
      "assigned_at": "2026-02-01T10:00:00",
      "is_current": false
    },
    {
      "level": 10,
      "authority_name": "Men's Hostel Deputy Warden",
      "authority_type": "Men's Hostel Deputy Warden",
      "escalated_at": "2026-02-02T15:00:00",
      "reason": "Needs higher authority approval",
      "is_current": true
    }
  ]
}


--- 6.10 Get Authority Stats ---
GET /api/authorities/stats
Auth: Authority token
Success: 200
Response: same structure as dashboard.stats


--- 6.11 Flag Complaint as Spam ---
POST /api/complaints/{complaint_id}/flag-spam
Auth: Authority token
Query: reason=string (REQUIRED)
Success: 200

Response: { "success": true, "message": "Complaint flagged as spam" }
Changes complaint status to "Spam". Student info becomes visible.


--- 6.12 Remove Spam Flag ---
POST /api/complaints/{complaint_id}/unflag-spam
Auth: Authority token
Success: 200
Response: { "success": true, "message": "Spam flag removed" }


================================================================================
SECTION 7: RESPONSE SCHEMAS (ComplaintResponse & ComplaintDetailResponse)
================================================================================

Every endpoint that returns complaints uses one of these two schemas.
Understanding them is critical for building complaint cards, lists, and detail views.

--- ComplaintResponse (used in lists/feeds) ---
{
  "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",   // UUID string
  "category_id": 1,                                  // integer
  "category_name": "Men's Hostel" | null,            // string or null
  "original_text": "The fan is broken in my room",   // student's original text
  "rephrased_text": "The ceiling fan in Room 204...", // AI-rephrased text (or null)
  "visibility": "Public",                            // "Private"|"Department"|"Public"
  "upvotes": 5,                                      // integer
  "downvotes": 0,                                    // integer
  "priority": "Medium",                              // "Low"|"Medium"|"High"|"Critical"
  "priority_score": 50.5,                            // float
  "status": "Raised",                                // see valid statuses
  "assigned_authority_name": "Men's Hostel Warden" | null,
  "is_marked_as_spam": false,                        // boolean
  "has_image": true,                                 // boolean
  "image_verified": true,                            // boolean
  "image_verification_status": "Verified" | "Pending" | "Rejected" | null,
  "submitted_at": "2026-02-01T10:00:00Z",           // ISO datetime
  "updated_at": "2026-02-01T12:00:00Z",             // ISO datetime
  "resolved_at": "2026-02-03T15:00:00Z" | null,     // null until resolved
  "student_roll_no": "22CS231" | null,               // null in public feed (privacy)
  "student_name": "Arjun Kumar" | null               // null in public feed (privacy)
}

--- ComplaintDetailResponse (extends ComplaintResponse, used in detail view) ---
{
  // ... all ComplaintResponse fields above, PLUS: ...
  "student_department": "1" | null,          // department ID as string, or null
  "student_gender": "Male" | null,
  "student_stay_type": "Hostel" | null,
  "student_year": 2 | null,
  "complaint_department_id": 1 | null,
  "is_cross_department": false,
  "status_updates": [                         // array of status change records
    {
      "old_status": "Raised",
      "new_status": "In Progress",
      "reason": "Maintenance team notified",
      "updated_by": 2,                        // authority ID (integer)
      "updated_at": "2026-02-01T12:00:00+00:00"
    }
  ] | null,
  "comments_count": 2,                       // integer
  "vote_count": 5,                           // integer
  "image_filename": "broken_fan.jpg" | null,
  "image_size": 245678 | null,               // bytes
  "image_mimetype": "image/jpeg" | null
}

--- ComplaintListResponse (wrapper for paginated lists) ---
{
  "complaints": [ ComplaintResponse, ... ],
  "total": 100,        // total matching records
  "page": 1,           // current page number
  "page_size": 20,     // items per page
  "total_pages": 5     // ceil(total / limit)
}

PAGINATION MATH:
  page = floor(skip / limit) + 1
  To get page N: skip = (N - 1) * limit
  Example: page 3 with 20 per page -> skip=40, limit=20


================================================================================
SECTION 8: ADMIN ENDPOINTS
================================================================================

Admin is an Authority with authority_level=100.
Login via POST /api/authorities/login with admin credentials.
All admin endpoints are at /api/admin/* prefix.

--- 8.1 Create Authority ---
POST /api/admin/authorities
Auth: Admin token
Content-Type: application/json
Success: 201

Request:
{
  "name": "New Warden",
  "email": "newwarden@srec.ac.in",
  "password": "Warden@1234",
  "phone": "9876543210",              // optional
  "authority_type": "Men's Hostel Warden",
  "department_id": null,               // null for non-HOD, integer for HOD
  "designation": "Warden Block C",     // optional
  "authority_level": 5                 // 1-100
}

Response: { "success": true, "message": "Authority created successfully" }
Errors: 409 if email already exists


--- 8.2 List All Authorities ---
GET /api/admin/authorities?skip=0&limit=50&is_active=true
Auth: Admin token
Success: 200

Response:
{
  "authorities": [ AuthorityProfile, ... ],
  "total": 23
}


--- 8.3 Toggle Authority Active Status ---
PUT /api/admin/authorities/{authority_id}/toggle-active?activate=true
Auth: Admin token
Success: 200
Cannot toggle yourself (prevents self-lockout).
Response: { "success": true, "message": "..." }


--- 8.4 Delete Authority ---
DELETE /api/admin/authorities/{authority_id}
Auth: Admin token
Success: 200
Cannot delete yourself. Cannot delete if authority has assigned complaints.
Response: { "success": true, "message": "..." }


--- 8.5 List All Students ---
GET /api/admin/students?skip=0&limit=50&is_active=true&department_id=1
Auth: Admin token
Success: 200

Response:
{
  "students": [ StudentProfile, ... ],
  "total": 150
}


--- 8.6 Toggle Student Active Status ---
PUT /api/admin/students/{roll_no}/toggle-active?activate=false
Auth: Admin token
Success: 200
Response: { "success": true, "message": "..." }
Deactivated students cannot login (403 Account inactive).


--- 8.7 System Overview Stats ---
GET /api/admin/stats/overview
Auth: Admin token
Success: 200

Response:
{
  "total_students": 500,
  "total_authorities": 23,
  "total_complaints": 1200,
  "recent_complaints_7d": 45,
  "complaints_by_status": {
    "Raised": 100,
    "In Progress": 200,
    "Resolved": 700,
    "Closed": 150,
    "Spam": 50
  },
  "complaints_by_priority": {
    "Low": 400,
    "Medium": 500,
    "High": 250,
    "Critical": 50
  },
  "complaints_by_category": {
    "Men's Hostel": 300,
    "Women's Hostel": 200,
    "General": 400,
    "Department": 200,
    "Disciplinary Committee": 100
  },
  "image_statistics": {
    "total_with_images": 300,
    "verified": 250,
    "pending": 30,
    "rejected": 20
  }
}


--- 8.8 Advanced Analytics ---
GET /api/admin/stats/analytics?days=30
Auth: Admin token
Success: 200

Query: days = 1-365, default 30

Response:
{
  "period_days": 30,
  "total_complaints": 200,
  "resolved_complaints": 150,
  "resolution_rate_percent": 75.0,
  "avg_resolution_time_hours": 36.5,
  "daily_complaints": [
    { "date": "2026-02-01", "count": 8 },
    { "date": "2026-02-02", "count": 12 },
    ...
  ]
}


--- 8.9 Bulk Status Update ---
POST /api/admin/complaints/bulk-status-update
Auth: Admin token
Success: 200

Query Parameters:
  complaint_ids  list of UUID strings (comma-separated or repeated param)
  new_status     "Raised"|"In Progress"|"Resolved"|"Closed"|"Spam"
  reason         string, required

Response: { "success": true, "message": "Updated N complaints" }


--- 8.10 Get Pending Image Verifications ---
GET /api/admin/images/pending-verification?skip=0&limit=20
Auth: Admin token
Success: 200

Response:
{
  "total": 5,
  "pending_images": [
    {
      "complaint_id": "uuid-string",
      "student_roll_no": "22CS231",
      "category": "Men's Hostel",
      "complaint_text": "Fan broken in room 204...",
      "image_filename": "photo.jpg",
      "image_size_kb": 245,
      "submitted_at": "2026-02-01T10:00:00"
    }
  ]
}


--- 8.11 Moderate Image ---
POST /api/admin/images/{complaint_id}/moderate?approve=true
Auth: Admin token
Success: 200

Query: approve=true (approve) or approve=false (reject)
       reason=string (required if rejecting)

Response: { "success": true, "message": "Image approved/rejected" }


--- 8.12 System Health Metrics ---
GET /api/admin/health/metrics
Auth: Admin token
Success: 200

Response:
{
  "database_size_mb": 45.6,
  "pending_complaints": 15,
  "old_unresolved_7d": 3,
  "image_statistics": { ... },
  "timestamp": "2026-02-11T10:00:00"
}


================================================================================
SECTION 9: VISIBILITY & PRIVACY RULES
================================================================================

This section explains who can see what. Critical for building the correct UI.

--- COMPLAINT VISIBILITY LEVELS (✅ UPDATED: 2 OPTIONS) ---

When a student submits a complaint, they choose visibility:
  "Private"    -> Only the student who submitted + assigned authority can see
  "Public"     -> All students can see (with automatic filtering below)

  NOTE: "Department" visibility was REMOVED. Only "Private" and "Public" remain.

--- PUBLIC FEED FILTERING (backend auto-applies) ---

When a student calls GET /api/complaints/public-feed, the backend filters:

  1. ONLY "Public" visibility complaints are returned
  2. "Closed" status complaints are HIDDEN
  3. ✅ GENDER-BASED HOSTEL FILTERING:
     - Day Scholar students CANNOT see ANY hostel complaints
     - Male Hostel students CANNOT see Women's Hostel complaints
     - Female Hostel students CANNOT see Men's Hostel complaints
  4. ✅ INTER-DEPARTMENT FILTERING WITH EXCEPTIONS:
     - Students ONLY see complaints from their OWN department
     - EXCEPTION: "General" category complaints visible to ALL
     - EXCEPTION: "Disciplinary Committee" complaints visible to ALL
     - EXCEPTION: Cross-department complaints visible to TARGET department
     - Example: CSE student sees (CSE + General + Disciplinary)
     - Example: CSE student → "ECE lab" complaint → ECE students see it

FRONTEND IMPACT:
  - Don't show hostel filters to Day Scholars
  - Don't show Women's Hostel to males, Men's Hostel to females
  - Public feed is automatically filtered - no client-side filtering needed

--- STUDENT IDENTITY PRIVACY ---

In PUBLIC FEED:
  student_roll_no = null
  student_name = null
  (complaints are anonymous)

In MY-COMPLAINTS:
  student_roll_no = visible (it's their own)
  student_name = visible

FOR AUTHORITIES viewing assigned complaints:
  Non-spam complaints: student_roll_no = null, student_name = null
  Spam complaints: student_roll_no = VISIBLE, student_name = VISIBLE
  Admin (level 100): ALL student info ALWAYS visible

FRONTEND IMPACT:
  - In public feed cards, do NOT show "Submitted by" -- it will always be null
  - In authority view, show "Anonymous" for non-spam, show name for spam
  - Admin dashboard can show student info on all complaints


================================================================================
SECTION 10: VOTING & PRIORITY SYSTEM
================================================================================

--- HOW VOTING WORKS ---

Students can vote on complaints visible in their public/department feed.
Each student can vote ONCE per complaint (Upvote or Downvote).

ENDPOINTS:
  POST   /api/complaints/{id}/vote       -> cast vote
  DELETE /api/complaints/{id}/vote       -> remove vote
  GET    /api/complaints/{id}/my-vote    -> check if already voted

REQUEST FORMAT (vote):
  { "vote_type": "Upvote" }   // or "Downvote"
  WARNING: Must be "Upvote" with capital U, not "upvote"

--- PRIORITY SCORE CALCULATION ---

Each complaint has a priority_score (float) that determines its priority level.

Base scores set by LLM on submission:
  Low      -> base 10
  Medium   -> base 50
  High     -> base 100
  Critical -> base 200

Vote impact:
  Each Upvote adds +5 to priority_score
  Each Downvote adds -3 to priority_score

Priority thresholds (auto-calculated):
  priority_score < 50     -> "Low"
  50 <= score < 100       -> "Medium"
  100 <= score < 200      -> "High"
  score >= 200            -> "Critical"

EXAMPLE:
  Complaint submitted with priority "Medium" (base score 50)
  Gets 10 upvotes and 2 downvotes
  New score = 50 + (10 * 5) + (2 * -3) = 50 + 50 - 6 = 94
  Priority stays "Medium" (94 < 100)

  Gets 2 more upvotes
  Score = 94 + 10 = 104
  Priority changes to "High"

FRONTEND TIPS:
  - Show priority badge with color: Low=gray, Medium=yellow, High=orange, Critical=red
  - Show upvote/downvote counts on complaint cards
  - Disable vote button if user already voted (check my-vote endpoint)
  - Allow vote removal (un-vote)


================================================================================
SECTION 11: IMAGE HANDLING
================================================================================

--- IMAGE SPECS ---
  Supported: JPEG, JPG, PNG, GIF, WebP
  Max size: 5 MB
  Max dimensions: 4096 x 4096 px
  Thumbnail: 200x200 auto-generated
  Storage: Binary in PostgreSQL (not filesystem, not cloud)

--- UPLOADING ---

Option A: Upload with complaint submission
  POST /api/complaints/submit (multipart/form-data)
  Field name: "image"

Option B: Upload to existing complaint
  POST /api/complaints/{id}/upload-image (multipart/form-data)
  Field name: "file"

NOTE: Different field names! "image" for submit, "file" for separate upload.

--- RETRIEVING ---

GET /api/complaints/{complaint_id}/image
  Returns raw binary image data
  Headers: Authorization: Bearer <token>
  Query: thumbnail=true for 200x200 version

FRONTEND CODE:
  // Cannot use <img src="..."> directly because auth header is needed
  async function getImageUrl(complaintId, token, thumbnail = false) {
    const res = await fetch(
      `/api/complaints/${complaintId}/image?thumbnail=${thumbnail}`,
      { headers: { 'Authorization': `Bearer ${token}` } }
    );
    if (!res.ok) return null;
    const blob = await res.blob();
    return URL.createObjectURL(blob);
  }

  // Remember to revoke URL when done to prevent memory leaks:
  // URL.revokeObjectURL(url);

--- VERIFICATION ---

AI (Groq Vision) automatically verifies if uploaded image is relevant.
Three statuses:
  "Pending"   -> not yet verified
  "Verified"  -> AI confirms image is relevant
  "Rejected"  -> AI says image is unrelated

Frontend should show verification badge on complaint cards:
  has_image=true,  image_verification_status="Verified"  -> green check
  has_image=true,  image_verification_status="Pending"   -> yellow clock
  has_image=true,  image_verification_status="Rejected"  -> red X
  has_image=false                                        -> no badge

The LLM can also REQUIRE an image for certain complaints (e.g., infrastructure
damage). If required but not provided, submission is rejected with 400.


================================================================================
SECTION 12: ERROR HANDLING & COMMON PATTERNS
================================================================================

--- STANDARD ERROR FORMAT ---

ALL errors return this JSON structure:
{
  "success": false,
  "error": "Human-readable error message",
  "error_code": "AUTH_002",
  "details": { ... } | null,
  "request_id": "uuid-string"
}

--- COMMON ERROR CODES ---

Auth errors:
  AUTH_001  Authentication error (generic)
  AUTH_002  Invalid credentials (wrong email/password)
  AUTH_003  Token expired (redirect to login)
  AUTH_004  Invalid token (malformed JWT)
  AUTH_005  Account inactive (admin deactivated)

Permission errors:
  AUTHZ_001  Unauthorized (wrong role)
  AUTHZ_002  Insufficient permissions

Validation errors:
  VAL_001  Validation error (see details.validation_errors)
  VAL_002  Duplicate entry (email/roll_no exists)

Not found:
  RES_001  Resource not found (generic)
  RES_002  Student not found
  RES_003  Complaint not found
  RES_004  Authority not found

Business logic:
  BIZ_001  Spam detected
  BIZ_004  Invalid status transition
  BIZ_005  Duplicate vote

File errors:
  FILE_001  Invalid file type
  FILE_002  File too large (>5MB)

--- VALIDATION ERROR DETAIL FORMAT (422) ---
{
  "success": false,
  "error": "Validation error",
  "error_code": "VALIDATION_ERROR",
  "details": {
    "validation_errors": [
      {
        "field": "password",
        "message": "String should have at least 8 characters",
        "type": "string_too_short"
      },
      {
        "field": "email",
        "message": "value is not a valid email address",
        "type": "value_error"
      }
    ]
  }
}

FRONTEND TIP: Loop through details.validation_errors and show inline
errors next to each form field.

--- HANDLING TOKEN EXPIRY ---

When any request returns error_code "AUTH_003":
  1. Clear stored token
  2. Redirect to login page
  3. Show "Session expired, please login again"

--- HANDLING RATE LIMITS ---

If API returns 429 Too Many Requests:
  { "error_code": "BIZ_003", "error": "Rate limit exceeded" }
  Show: "Too many requests. Please wait and try again."

--- PAGINATION PATTERN ---

All list endpoints use:
  Query: ?skip=0&limit=20
  Response: { items: [...], total, page, page_size, total_pages }

  Page N with size S: skip = (N-1) * S, limit = S
  Has next page: page < total_pages
  Has prev page: page > 1

--- HEALTH CHECK ---

GET /health
No auth needed. Use to check if server is alive.
Response: { "status": "ok", "service": "CampusVoice" }

GET /health/detailed
Response: { "status": "ok", "database": "connected", "environment": "..." }


================================================================================
SECTION 13: FRONTEND-BACKEND GAP ANALYSIS & MIGRATION GUIDE
================================================================================

If your frontend was built with old/incorrect assumptions, here are the fixes:

--- GAP 1: THREE ROLES, NOT TWO ---
OLD: Frontend has "student" and "admin" login
NEW: Backend has Student, Authority, and Admin
FIX: Create THREE login flows:
  - Student login: POST /api/students/login
  - Authority login: POST /api/authorities/login (Wardens, HODs, Officers)
  - Admin login: POST /api/authorities/login (same endpoint, different credentials)
  After login, decode JWT "role" field to determine which dashboard to show.

--- GAP 2: DEPARTMENT IDs, NOT STRINGS ---
OLD: Frontend sends department as string like "CSE"
NEW: Backend requires integer department_id (1-13)
FIX: Map string codes to IDs:
  CSE=1, ECE=2, RAA=3, MECH=4, EEE=5, EIE=6, BIO=7,
  AERO=8, CIVIL=9, IT=10, MBA=11, AIDS=12, MTECH_CSE=13
  Always send department_id as integer in registration and filtering.

--- GAP 3: NO CATEGORY SELECTION REQUIRED (FULLY AI-DRIVEN) ---
OLD: Frontend has category dropdown where students select from 4-5 categories
NEW: Backend uses AI to automatically determine category - NO user input needed
FIX: **REMOVE THE CATEGORY DROPDOWN ENTIRELY** from complaint submission form.

  Frontend Changes Required:
  1. ❌ REMOVE: category_id dropdown/selector
  2. ❌ REMOVE: "Department" from visibility options (only Private/Public)
  3. ✅ ADD: Instruction text: "Describe your complaint. Our AI will automatically
     categorize and route it to the appropriate authority."
  4. ✅ KEEP: original_text textarea (10-2000 chars, required)
  5. ✅ KEEP: visibility radio (Private/Public only, default Public)
  6. ✅ KEEP: image upload (optional, max 5MB)

  What the AI Does Automatically:
  - Analyzes complaint text to determine category
  - Detects target department from keywords (e.g., "ECE lab" → ECE)
  - Routes cross-department complaints correctly
  - Backend still validates (Day Scholars can't submit hostel complaints)

  New Response Fields to Display:
  - category: "Men's Hostel" (show badge with color)
  - target_department_code: "CSE" (show if cross_department=true)
  - cross_department: false (show "Cross-Department" badge if true)
  - confidence_score: 0.9 (show as percentage: "90% confident")
  - llm_failed: false (show warning if true: "Auto-categorization unavailable")

--- GAP 4: STATUS VOCABULARY ---
OLD: Frontend uses "opened", "reviewed", "pending"
NEW: Backend uses exactly:
  "Raised", "In Progress", "Resolved", "Closed", "Spam"
FIX: Replace all frontend status strings with backend values.
  These are case-sensitive. "raised" will NOT work, must be "Raised".

--- GAP 5: VOTE TYPE CASING ---
OLD: Frontend sends "upvote"/"downvote" (lowercase)
NEW: Backend requires "Upvote"/"Downvote" (capital first letter)
FIX: Change vote_type values to "Upvote" and "Downvote".

--- GAP 6: AUTHORITY SCORE FIELD ---
QUESTION: "What is authority_score / performance_rating?"
ANSWER: The AuthorityStats response includes two fields:
  avg_resolution_time_hours: null (NOT YET IMPLEMENTED)
  performance_rating: null (NOT YET IMPLEMENTED)
  These are placeholder fields for future features.
  Do NOT build UI features around them yet -- they always return null.
  When implemented: performance_rating will be 0.0-5.0 based on resolution
  speed, complaint volume, and escalation rate.

--- GAP 7: COMPLAINT SUBMIT IS MULTIPART (NO CATEGORY_ID) ---
OLD: Frontend sends complaint as JSON with category_id
NEW: Backend expects multipart/form-data WITHOUT category_id (fully AI-driven)
FIX: Use FormData() in JavaScript - NO category_id field:

  const formData = new FormData();
  // ❌ DO NOT append category_id - field is deprecated/ignored
  formData.append('original_text', 'The ECE lab oscilloscopes are broken...');
  formData.append('visibility', 'Public');  // Only "Private" or "Public"
  if (imageFile) formData.append('image', imageFile);  // Optional

  fetch('/api/complaints/submit', {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + studentToken },
    // DO NOT set Content-Type - browser adds multipart boundary automatically
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    console.log('AI Category:', data.category);              // "Department"
    console.log('Target Dept:', data.target_department_code); // "ECE"
    console.log('Cross-Dept:', data.cross_department);       // true
    console.log('Confidence:', data.confidence_score);       // 0.95
  });

--- GAP 8: IMAGE RETRIEVAL NEEDS AUTH ---
OLD: Frontend uses <img src="/api/complaints/{id}/image">
NEW: Image endpoint requires Authorization header
FIX: Fetch with auth header, create blob URL:
  const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` }});
  const blob = await res.blob();
  img.src = URL.createObjectURL(blob);

--- GAP 9: NOTIFICATIONS ARE PER-ROLE ---
Students see: status updates, vote milestones, resolution notices
Authorities see: new complaint assignments, escalation notices
Use the correct notifications endpoint for each role.

--- GAP 10: ADMIN ENDPOINTS ---
OLD: Frontend has no admin section
NEW: Backend has full admin panel at /api/admin/*
FIX: Build admin dashboard with:
  - Authority management (create/list/toggle/delete)
  - Student management (list/toggle)
  - System stats (overview, analytics)
  - Bulk operations (mass status update)
  - Image moderation (pending verification queue)
  - Health metrics


================================================================================
SECTION 14: COMPLETE WORKFLOW EXAMPLES
================================================================================

--- WORKFLOW A: STUDENT JOURNEY ---

1. Register:
   POST /api/students/register
   Body: { roll_no, name, email, password, gender, stay_type, department_id, year }
   Save token from response.

2. Submit complaint (✅ NO category_id):
   POST /api/complaints/submit (multipart/form-data)
   Fields: original_text="The Men's Hostel water heater in Block A is broken",
           visibility=Public,
           image=<optional file>
   NOTE: AI automatically determines category from complaint text

   Response includes AI fields:
   {
     "id": "uuid-string",
     "status": "Submitted",
     "message": "Your complaint has been assigned to Men's Hostel Warden",
     "rephrased_text": "The water heating system...",
     "priority": "High",
     "assigned_authority": "Men's Hostel Warden",
     "category": "Men's Hostel",                 // ✅ AI-determined
     "target_department_id": 1,                  // ✅ CSE
     "target_department_code": "CSE",            // ✅ String code
     "cross_department": false,                  // ✅ true if cross-dept
     "llm_failed": false,                        // ✅ keyword fallback flag
     "confidence_score": 0.95,                   // ✅ AI confidence
     "has_image": false,
     "image_verified": false
   }

3. Browse public feed:
   GET /api/complaints/public-feed?skip=0&limit=20
   Display complaint cards (anonymous - no student names shown)

4. Vote on someone's complaint:
   POST /api/complaints/{id}/vote
   Body: { "vote_type": "Upvote" }

5. Check notifications:
   GET /api/students/notifications?unread_only=true
   Show bell icon with unread_count badge

6. View complaint timeline:
   GET /api/complaints/{id}/timeline
   Show status change history with timestamps

7. Track own complaints:
   GET /api/students/my-complaints
   Filter by status if needed

--- WORKFLOW B: AUTHORITY JOURNEY ---

1. Login:
   POST /api/authorities/login
   Body: { email, password }
   Save token.

2. View dashboard:
   GET /api/authorities/dashboard
   Show stats, recent complaints, urgent complaints

3. Review assigned complaint:
   GET /api/authorities/complaints/{id}
   See complaint details, status history

4. Update status:
   PUT /api/authorities/complaints/{id}/status
   Body: { "status": "In Progress", "reason": "Team dispatched" }

5. Post progress update:
   POST /api/authorities/complaints/{id}/post-update?title=Update&content=Working on it

6. Escalate if needed:
   POST /api/authorities/complaints/{id}/escalate?reason=Needs higher approval

7. Resolve:
   PUT /api/authorities/complaints/{id}/status
   Body: { "status": "Resolved", "reason": "Issue fixed and verified" }

--- WORKFLOW C: ADMIN JOURNEY ---

1. Login (same as authority):
   POST /api/authorities/login
   Body: { "email": "admin@srec.ac.in", "password": "Admin@123456" }

2. View system overview:
   GET /api/admin/stats/overview
   Show total students, authorities, complaints breakdown

3. View analytics:
   GET /api/admin/stats/analytics?days=30
   Show charts: daily complaints, resolution rate

4. Manage authorities:
   GET /api/admin/authorities (list all)
   POST /api/admin/authorities (create new)
   PUT /api/admin/authorities/{id}/toggle-active (enable/disable)
   DELETE /api/admin/authorities/{id} (remove)

5. Manage students:
   GET /api/admin/students (list all, filter by department)
   PUT /api/admin/students/{roll_no}/toggle-active (ban/unban)

6. Moderate images:
   GET /api/admin/images/pending-verification
   POST /api/admin/images/{id}/moderate?approve=true

7. Bulk operations:
   POST /api/admin/complaints/bulk-status-update
   (Mass close spam complaints, etc.)


================================================================================
END OF DOCUMENT
================================================================================
